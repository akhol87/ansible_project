---
# deploy.yml â€” runs ONLY on Swarm manager

- name: Ensure Python is installed (manager only)
  command: dnf install -y python3 --disablerepo=appstream
  become: yes

- name: Ensure pip is installed (manager only)
  command: dnf install -y python3-pip --disablerepo=appstream
  become: yes

- name: Ensure Docker SDK for Python is installed
  pip:
    name: docker
    executable: pip3
  become: yes

- name: Create working directory
  file:
    path: /tmp/webapp-build
    state: directory
    mode: '0755'
  become: yes

- name: Download application archive
  get_url:
    url: "{{ app_download_url }}"
    dest: "/tmp/{{ app_archive }}"
    mode: '0644'
  become: yes

- name: Extract application files
  unarchive:
    src: "/tmp/{{ app_archive }}"
    dest: /tmp/webapp-build/
    remote_src: yes
  become: yes

- name: Create Dockerfile
  template:
    src: Dockerfile.j2
    dest: /tmp/webapp-build/Dockerfile
    mode: '0644'
  become: yes

- name: Build Docker image
  docker_image:
    name: "{{ app_image_name }}"
    tag: latest
    source: build
    build:
      path: /tmp/webapp-build
      pull: yes
  become: yes

- name: Create overlay network
  docker_network:
    name: webapp-network
    driver: overlay
    attachable: yes
  become: yes

- name: Deploy application stack
  docker_stack:
    name: "{{ app_name }}"
    compose:
      - version: "3.8"
        services:
          web:
            image: "{{ app_image_name }}:latest"
            deploy:
              replicas: "{{ app_replicas }}"
              placement:
                constraints:
                  - node.role == worker
            ports:
              - "{{ app_port }}:80"
            networks:
              - webapp-network
        networks:
          webapp-network:
            external: true
  become: yes
